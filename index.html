<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏õ‡∏û.5 Digital Cloud v27.3 (Minimal White)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Prompt', sans-serif;
            background-color: #f8fafc;
            font-size: 18px;
            color: #1e293b;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Navbar ‡πÇ‡∏ó‡∏ô‡∏Ç‡∏≤‡∏ß‡∏Ñ‡∏•‡∏µ‡∏ô Glassmorphism */
        nav.glass-nav {
            background: rgba(255, 255, 255, 0.85) !important;
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        .nav-selector {
            background: #ffffff !important;
            color: #475569 !important;
            border: 1px solid #e2e8f0 !important;
            padding: 8px 16px;
            border-radius: 14px;
            font-weight: 700;
            font-size: 17px;
            outline: none;
            transition: all 0.3s;
            cursor: pointer;
        }

        .nav-selector:focus {
            border-color: #6366f1 !important;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .nav-selector option {
            background: white;
            color: #1e293b;
        }

        .nav-link-modern {
            color: #64748b;
            font-weight: 700;
            padding: 10px 18px;
            border-radius: 14px;
            transition: all 0.2s;
        }

        .nav-link-modern:hover {
            color: #4f46e5;
            background: #f1f5f9;
        }

        .nav-link-modern.active-tab {
            background: #eef2ff !important;
            color: #4f46e5 !important;
        }

        @media print {
            .no-print {
                display: none !important;
            }

            .a4-landscape {
                width: 297mm;
                min-height: 210mm;
                padding: 15mm;
                margin: 0 auto;
                background: white;
            }

            body {
                background: white;
            }
        }

        .btn-status {
            padding: 10px 18px;
            font-size: 16px;
            font-weight: 800;
            border-radius: 12px;
            transition: all 0.2s;
            border: 1px solid #e2e8f0;
        }

        #reader {
            width: 100%;
            max-width: 450px;
            margin: 0 auto;
            border-radius: 2rem;
            overflow: hidden;
            border: 4px solid #6366f1;
        }
    </style>
</head>

<body>

    <div id="app">
        <nav class="sticky top-0 z-50 no-print glass-nav h-24 flex items-center">
            <div class="max-w-7xl mx-auto px-6 w-full flex justify-between items-center">
                <div class="flex items-center space-x-6">
                    <div class="flex flex-col border-r border-slate-200 pr-6 mr-2">
                        <span class="text-2xl font-black text-slate-800 italic tracking-tighter logo-text">üè´ TEACHER
                            HUB</span>
                        <span class="text-[10px] text-indigo-500 font-bold tracking-[0.3em] uppercase text-center">Cloud
                            System</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <select id="gradeSelector" onchange="filterSubjects(this.value)" class="nav-selector">
                            <option value="">‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                        </select>
                        <select id="subjectSelector" onchange="changeActiveSubject(this.value)" class="nav-selector">
                            <option value="">‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</option>
                        </select>
                        <button onclick="openClassModal()"
                            class="bg-slate-800 text-white p-2.5 rounded-xl hover:bg-slate-700 transition-all shadow-md">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                    d="M12 4v16m8-8H4" />
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="hidden lg:flex items-center space-x-1">
                    <button id="nav-dashboard" onclick="switchTab('dashboard')"
                        class="nav-link-modern active-tab">‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</button>
                    <button id="nav-attendance" onclick="switchTab('attendance')"
                        class="nav-link-modern">‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</button>
                    <button id="nav-scores" onclick="switchTab('scores')" class="nav-link-modern">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
                    <button id="nav-qr-cards" onclick="switchTab('qr-cards')"
                        class="nav-link-modern text-orange-500">‡∏ö‡∏±‡∏ï‡∏£ QR</button>
                    <button onclick="switchTab('class-report')"
                        class="ml-4 bg-indigo-600 text-white px-7 py-3 rounded-2xl font-black hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-100">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto p-6 md:p-10">
            <div id="status-screen" class="text-center py-20 text-slate-400 font-bold">
                <div class="text-5xl mb-4 animate-pulse">üîç</div>
                <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô...</p>
            </div>

            <div id="main-ui" class="hidden space-y-10">
                <div id="tab-attendance" class="tab-content">
                    <div class="max-w-7xl mx-auto mb-8 no-print">
                        <div
                            class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100 flex flex-col lg:flex-row items-center justify-between gap-6">
                            <div class="flex items-center space-x-4">
                                <span class="font-black text-slate-500 uppercase text-sm tracking-wider">üìÖ
                                    ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠:</span>
                                <input type="date" id="global-att-date" onchange="syncAttendanceDate()"
                                    class="bg-slate-50 border border-slate-200 rounded-2xl p-3 text-slate-800 font-black outline-none focus:ring-2 ring-indigo-50 text-xl transition-all">
                            </div>
                            <div class="flex flex-wrap items-center gap-3">
                                <div class="bg-slate-100 p-2 rounded-2xl flex shadow-inner">
                                    <button onclick="setAttMode('scanner')" id="btn-mode-scanner"
                                        class="flex-1 md:px-8 py-3 rounded-xl text-xs font-black transition-all">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô
                                        QR</button>
                                    <button onclick="setAttMode('manual')" id="btn-mode-manual"
                                        class="flex-1 md:px-8 py-3 rounded-xl text-xs font-black transition-all">üìù
                                        ‡∏ï‡∏¥‡πä‡∏Å‡∏ä‡∏∑‡πà‡∏≠</button>
                                </div>
                                <button onclick="switchTab('att-summary-report')"
                                    class="bg-emerald-50 text-emerald-700 border border-emerald-200 px-8 py-4 rounded-2xl text-xs font-black hover:bg-emerald-600 hover:text-white transition-all">üìÑ
                                    ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col lg:flex-row gap-10">
                        <div class="w-full lg:w-1/2 space-y-6">
                            <div id="area-scanner"
                                class="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100 text-center">
                                <div id="reader"></div>
                            </div>
                            <div id="area-manual"
                                class="hidden bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100">
                                <div id="manual-list" class="space-y-3 max-h-[600px] overflow-y-auto pr-2"></div>
                            </div>
                        </div>
                        <div
                            class="w-full lg:w-1/2 bg-white p-8 rounded-[3rem] shadow-sm border border-slate-100 overflow-x-auto text-center">
                            <table class="w-full font-bold text-lg">
                                <thead class="text-slate-400 text-xs font-black uppercase tracking-widest border-b">
                                    <tr>
                                        <th class="p-4 text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                        <th>‡∏°‡∏≤</th>
                                        <th>‡∏Ç‡∏≤‡∏î</th>
                                        <th>‡∏•‡∏≤</th>
                                        <th>%</th>
                                    </tr>
                                </thead>
                                <tbody id="att-stats-body" class="divide-y text-xl"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="tab-att-summary-report" class="tab-content text-center">
                    <button onclick="window.print()"
                        class="no-print mb-8 bg-slate-800 text-white px-10 py-4 rounded-full font-bold shadow-xl">üñ®Ô∏è
                        ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                    <div id="att-summary-container"
                        class="a4-landscape shadow-xl border p-12 bg-white mx-auto rounded-[1rem] text-left"></div>
                </div>

                <div id="tab-dashboard" class="tab-content active">
                    <div
                        class="bg-white p-12 rounded-[3.5rem] border border-slate-100 shadow-sm mb-10 flex flex-col md:flex-row justify-between items-center text-center md:text-left">
                        <div>
                            <h2 id="header-grade"
                                class="text-indigo-500 font-bold uppercase tracking-widest text-sm mb-2">-</h2>
                            <h1 id="header-subject" class="text-5xl font-black text-slate-800 mb-2">-</h1>
                            <p id="header-code" class="text-xl text-slate-400 font-medium"></p>
                        </div>
                        <div class="mt-6 md:mt-0 flex gap-6">
                            <div class="text-center bg-slate-50 p-6 rounded-3xl w-32 border border-slate-100">
                                <p class="text-slate-400 text-xs font-bold mb-1 uppercase">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
                                <p id="dash-count" class="text-3xl font-black text-slate-800">0</p>
                            </div>
                            <div class="text-center bg-indigo-50 p-6 rounded-3xl w-32 border border-indigo-100">
                                <p class="text-indigo-400 text-xs font-bold mb-1 uppercase">‡πÄ‡∏Å‡∏£‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</p>
                                <p id="dash-avg" class="text-3xl font-black text-indigo-600">0.0</p>
                            </div>
                            <div class="text-center bg-emerald-50 p-6 rounded-3xl w-32 border border-emerald-100">
                                <p class="text-emerald-400 text-xs font-bold mb-1 uppercase">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
                                <p id="dash-att" class="text-3xl font-black text-emerald-500">0%</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-10 rounded-[3rem] shadow-sm border border-slate-100 h-96"><canvas
                            id="gradeChart"></canvas></div>
                </div>

                <div id="tab-scores" class="tab-content">
                    <div
                        class="bg-white rounded-[3.5rem] shadow-sm border border-slate-100 overflow-hidden text-center font-bold">
                        <div class="p-8 bg-white border-b border-slate-100 flex justify-between items-center">
                            <h3 class="text-xl font-black text-slate-800 uppercase">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</h3><button
                                onclick="openBulk()"
                                class="bg-slate-100 text-slate-600 px-8 py-3 rounded-2xl text-xs font-black hover:bg-slate-800 hover:text-white transition-all">+
                                ‡∏ô‡∏≥‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤</button>
                        </div>
                        <table class="w-full text-center font-bold text-2xl">
                            <thead class="bg-slate-50 text-slate-400 text-[10px] font-black uppercase tracking-widest">
                                <tr>
                                    <th class="p-6 w-16">‡∏ó‡∏µ‡πà</th>
                                    <th class="text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                    <th>‡πÄ‡∏Å‡πá‡∏ö</th>
                                    <th>‡∏Å‡∏•‡∏≤‡∏á</th>
                                    <th>‡∏õ‡∏•‡∏≤‡∏¢</th>
                                    <th class="p-6 bg-indigo-50 text-indigo-700">‡∏£‡∏ß‡∏°</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="score-body" class="divide-y text-slate-700"></tbody>
                        </table>
                    </div>
                </div>

                <div id="tab-qr-cards" class="tab-content text-center">
                    <button onclick="window.print()"
                        class="no-print mb-10 bg-slate-800 text-white px-14 py-4 rounded-full font-black shadow-xl">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ö‡∏±‡∏ï‡∏£
                        QR ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    <div id="qr-cards-container" class="grid grid-cols-1 md:grid-cols-4 gap-8"></div>
                </div>

                <div id="tab-class-report" class="tab-content text-center">
                    <div id="class-report-container"
                        class="a4-landscape shadow-xl border p-12 bg-white mx-auto rounded-[1rem] text-left"></div>
                </div>
            </div>
        </main>
    </div>

    <div id="classModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-md hidden z-[110] flex items-center justify-center p-4">
        <div class="bg-white rounded-[3rem] p-10 w-full max-w-lg shadow-2xl text-center border border-slate-100">
            <h3 class="text-2xl font-black mb-6 text-slate-800 italic uppercase tracking-tighter">‚ú® ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
            <div class="space-y-4 text-left font-bold"><input type="text" id="new-grade"
                    class="w-full border border-slate-200 bg-slate-50 rounded-2xl p-4 outline-none focus:border-indigo-400 transition-all"
                    placeholder="‡∏ä‡∏±‡πâ‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏õ.4)"><input type="text" id="new-code"
                    class="w-full border border-slate-200 bg-slate-50 rounded-2xl p-4 outline-none focus:border-indigo-400 transition-all"
                    placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ‡∏ó14101)"><input type="text" id="new-name"
                    class="w-full border border-slate-200 bg-slate-50 rounded-2xl p-4 outline-none focus:border-indigo-400 transition-all"
                    placeholder="‡∏ß‡∏¥‡∏ä‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢)"></div>
            <div class="mt-8 flex justify-end space-x-3"><button onclick="closeClassModal()"
                    class="text-slate-400 font-bold px-6">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button onclick="saveNewClass()"
                    class="bg-indigo-600 text-white px-10 py-3 rounded-2xl font-black shadow-lg">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>

    <div id="bulkModal"
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-md hidden z-[100] flex items-center justify-center p-4 no-print">
        <div
            class="bg-white rounded-[3rem] p-12 w-full max-w-lg shadow-2xl text-center font-bold border border-slate-100">
            <h3 class="text-xl font-bold mb-6">‡∏ô‡∏≥‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á</h3>
            <p class="text-[10px] text-slate-400 mb-4 italic text-center">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: [‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß][‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á][‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•]
            </p><textarea id="bulkInput" rows="10"
                class="w-full border border-slate-200 bg-slate-50 rounded-2xl p-6 outline-none focus:border-indigo-400 transition-all font-mono text-sm"
                placeholder="101 ‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ&#10;102 ‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏™‡∏∏‡∏î‡∏≤ ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô"></textarea>
            <div class="mt-8 flex justify-end space-x-3"><button onclick="closeBulk()"
                    class="text-slate-400 font-bold px-6">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button onclick="doBulk()"
                    class="bg-indigo-600 text-white px-8 py-2 rounded-2xl font-black shadow-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div>
        </div>
    </div>

    <script>
        const SB_URL = 'https://wfzyxmtvjprzsbyfgvtm.supabase.co';
        const SB_KEY = 'sb_publishable_1OVpNTSCOAYhFGa_aHvtxA_qSUY_Ni8';
        const _sb = supabase.createClient(SB_URL, SB_KEY);
        let classes = []; let activeSubj = null; let students = []; let scanner = null;

        async function init() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('global-att-date').value = today;
            const { data } = await _sb.from('classes').select('*').order('grade_level', { ascending: true });
            if (data) {
                classes = data;
                const uniqueGrades = [...new Set(classes.map(c => c.grade_level))];
                document.getElementById('gradeSelector').innerHTML = '<option value="">‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>' + uniqueGrades.map(g => `<option value="${g}">${g}</option>`).join('');
            }
        }

        function filterSubjects(grade) {
            const filtered = classes.filter(c => c.grade_level === grade);
            document.getElementById('subjectSelector').innerHTML = '<option value="">‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</option>' + filtered.map(s => `<option value="${s.id}">${s.subject_name}</option>`).join('');
        }

        async function changeActiveSubject(id) {
            if (!id) return;
            activeSubj = classes.find(c => c.id == id);
            await loadData();
            document.getElementById('status-screen').classList.add('hidden');
            document.getElementById('main-ui').classList.remove('hidden');
            document.getElementById('header-grade').innerText = "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô " + activeSubj.grade_level;
            document.getElementById('header-subject').innerText = activeSubj.subject_name;
            document.getElementById('header-code').innerText = "‡∏£‡∏´‡∏±‡∏™: " + activeSubj.subject_code;
        }

        async function loadData() {
            const { data } = await _sb.from('students').select('*, scores(*), attendance(*)').eq('class_name', activeSubj.grade_level).order('roll_number', { ascending: true });
            students = data || [];
            renderDashboard(); renderAttendance(); renderStats(); renderScores();
        }

        function syncAttendanceDate() { if (activeSubj) renderAttendance(); }

        function renderAttendance() {
            const date = document.getElementById('global-att-date').value;
            document.getElementById('manual-list').innerHTML = students.map(s => {
                const record = s.attendance.find(a => a.check_date === date && a.subject_name === activeSubj.subject_name);
                const status = record ? record.status : "";
                return `<div class="flex items-center justify-between p-4 bg-white border border-slate-100 rounded-3xl font-bold shadow-sm transition hover:border-indigo-200"><span>${s.name}</span><div class="flex space-x-1"><button onclick="setAtt('${s.id}','P')" class="btn-status ${status === 'P' ? 'bg-emerald-500 text-white shadow-lg border-emerald-500' : 'bg-slate-50 text-slate-300'}">‡∏°‡∏≤</button><button onclick="setAtt('${s.id}','A')" class="btn-status ${status === 'A' ? 'bg-red-500 text-white shadow-lg border-red-500' : 'bg-white text-slate-300'}">‡∏Ç‡∏≤‡∏î</button><button onclick="setAtt('${s.id}','L')" class="btn-status ${status === 'L' ? 'bg-amber-500 text-white shadow-lg border-amber-500' : 'bg-white text-slate-300'}">‡∏•‡∏≤</button></div></div>`;
            }).join('');
        }

        async function setAtt(id, status) {
            const date = document.getElementById('global-att-date').value;
            await _sb.from('attendance').upsert({ student_id: id, check_date: date, status: status, subject_name: activeSubj.subject_name }, { onConflict: 'student_id, check_date, subject_name' });
            await loadData();
        }

        function renderStats() {
            document.getElementById('att-stats-body').innerHTML = students.map(s => {
                const atts = s.attendance.filter(a => a.subject_name === activeSubj.subject_name);
                const p = atts.filter(a => a.status === 'P').length, a = atts.filter(a => a.status === 'A').length, l = atts.filter(a => a.status === 'L').length;
                const total = p + a + l; const pct = total > 0 ? ((p / total) * 100).toFixed(0) : 0;
                return `<tr><td class="p-4 text-left font-bold text-slate-700">${s.name}</td><td>${p}</td><td>${a}</td><td>${l}</td><td class="text-indigo-600 font-black">${pct}%</td></tr>`;
            }).join('');
        }

        function renderAttendanceSummaryReport() {
            const con = document.getElementById('att-summary-container');
            let html = `<div class="text-center mb-10"><h1 class="text-4xl font-black uppercase tracking-tighter text-slate-900 mb-2">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1><p class="text-2xl font-bold text-indigo-600 tracking-wide">‡∏ß‡∏¥‡∏ä‡∏≤: ${activeSubj.subject_name} (${activeSubj.subject_code}) | ‡∏ä‡∏±‡πâ‡∏ô: ${activeSubj.grade_level}</p><p class="text-slate-400 font-bold mt-2 italic">‡∏™‡∏∞‡∏™‡∏° ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${new Date().toLocaleDateString('th-TH')}</p></div><table class="w-full text-center border-collapse border-4 border-slate-900 text-lg font-bold"><thead><tr class="bg-slate-100"><th class="border-4 border-slate-900 p-4 w-16">‡∏ó‡∏µ‡πà</th><th class="border-4 border-slate-900 p-4 text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th class="border-4 border-slate-900 p-4 w-28 text-emerald-600">‡∏°‡∏≤</th><th class="border-4 border-slate-900 p-4 w-28 text-red-600">‡∏Ç‡∏≤‡∏î</th><th class="border-4 border-slate-900 p-4 w-28 text-amber-600">‡∏•‡∏≤</th><th class="border-4 border-slate-900 p-4 w-32 bg-indigo-50 text-indigo-700">‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞</th></tr></thead><tbody>`;
            students.forEach(s => {
                const atts = s.attendance.filter(a => a.subject_name === activeSubj.subject_name);
                const p = atts.filter(a => a.status === 'P').length, a = atts.filter(a => a.status === 'A').length, l = atts.filter(a => a.status === 'L').length;
                const total = p + a + l; const pct = total > 0 ? ((p / total) * 100).toFixed(0) : 0;
                html += `<tr><td class="border-4 border-slate-900 p-3 text-center">${s.roll_number}</td><td class="border-4 border-slate-900 p-3 text-left font-bold text-slate-800">${s.name}</td><td class="border-4 border-slate-900 p-3 text-center">${p}</td><td class="border-4 border-slate-900 p-3 text-center">${a}</td><td class="border-4 border-slate-900 p-3 text-center">${l}</td><td class="border-4 border-slate-900 p-3 font-black text-2xl text-center">${pct}%</td></tr>`;
            });
            html += `</tbody></table><div class="mt-20 flex justify-between font-black italic px-10"><div class="text-center"><p class="mb-14 text-slate-300">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠.........................................</p><p>( ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ù‡πà‡∏≤‡∏¢‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô )</p></div><div class="text-center"><p class="mb-14 text-slate-300">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠.........................................</p><p>( ‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô: ${activeSubj.subject_name} )</p></div></div>`;
            con.innerHTML = html;
        }

        async function doBulk() {
            const input = document.getElementById('bulkInput').value.trim().split('\n');
            let currentRoll = 1;
            for (const l of input) {
                const p = l.split(/\s+/); if (p.length < 2) continue;
                await _sb.from('students').insert({ std_id: p[0], name: p.slice(1).join(" "), class_name: activeSubj.grade_level, roll_number: currentRoll });
                currentRoll++;
            }
            location.reload();
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-link-modern').forEach(el => el.classList.remove('active-tab'));

            document.getElementById('tab-' + id).classList.add('active');
            const navBtn = document.getElementById('nav-' + id);
            if (navBtn) navBtn.classList.add('active-tab');

            if (id === 'attendance') setAttMode('scanner'); else stopScanner();
            if (id === 'qr-cards') renderQRCards();
            if (id === 'class-report') renderClassSummary();
            if (id === 'att-summary-report') renderAttendanceSummaryReport();
        }

        function setAttMode(m) {
            document.getElementById('area-scanner').classList.toggle('hidden', m !== 'scanner');
            document.getElementById('area-manual').classList.toggle('hidden', m === 'scanner');
            if (m === 'scanner') startScanner(); else stopScanner();
            document.getElementById('btn-mode-scanner').className = m === 'scanner' ? 'flex-1 md:px-6 py-3 rounded-xl text-xs font-black bg-indigo-600 text-white shadow-md' : 'flex-1 md:px-6 py-3 rounded-xl text-xs font-black text-slate-400';
            document.getElementById('btn-mode-manual').className = m === 'manual' ? 'flex-1 md:px-6 py-3 rounded-xl text-xs font-black bg-indigo-600 text-white shadow-md' : 'flex-1 md:px-6 py-3 rounded-xl text-xs font-black text-slate-400';
        }

        function startScanner() {
            if (!scanner) scanner = new Html5Qrcode("reader");
            const date = document.getElementById('global-att-date').value;
            scanner.start({ facingMode: "environment" }, { fps: 20, qrbox: 250 }, (text) => {
                const std = students.find(s => s.std_id === text.trim());
                if (std) {
                    _sb.from('attendance').upsert({ student_id: std.id, check_date: date, status: 'P', subject_name: activeSubj.subject_name }, { onConflict: 'student_id, check_date, subject_name' }).then(() => {
                        if (navigator.vibrate) navigator.vibrate(100);
                        loadData();
                    });
                }
            }).catch(err => { console.error(err); });
        }

        function renderScores() {
            document.getElementById('score-body').innerHTML = students.map(s => {
                const sc = s.scores.find(x => x.subject_name === activeSubj.subject_name) || { collect_score: 0, midterm_score: 0, final_score: 0 };
                return `<tr><td class="p-6 text-slate-300 font-bold text-center">${s.roll_number}</td><td class="text-left font-bold text-slate-800">${s.name}</td><td class="text-center"><input type="number" onchange="upSc('${s.id}','collect',this.value)" value="${sc.collect_score}" class="w-20 text-center bg-slate-50 rounded-xl p-3 border-none ring-1 ring-slate-200 outline-none"></td><td class="text-center"><input type="number" onchange="upSc('${s.id}','midterm',this.value)" value="${sc.midterm_score}" class="w-20 text-center bg-slate-50 rounded-xl p-3 border-none ring-1 ring-slate-200 outline-none"></td><td class="text-center"><input type="number" onchange="upSc('${s.id}','final',this.value)" value="${sc.final_score}" class="w-20 text-center bg-slate-50 rounded-xl p-3 border-none ring-1 ring-slate-200 outline-none"></td><td class="p-6 font-black text-indigo-700 bg-indigo-50/50 text-center">${sc.collect_score + sc.midterm_score + sc.final_score}</td><td class="text-center"><button onclick="delStd('${s.id}')" class="text-red-300 font-bold hover:text-red-500 transition">‡∏•‡∏ö</button></td></tr>`;
            }).join('');
        }

        async function upSc(id, field, val) {
            let sc = { student_id: id, subject_name: activeSubj.subject_name };
            sc[field + '_score'] = parseFloat(val) || 0;
            await _sb.from('scores').upsert(sc, { onConflict: 'student_id, subject_name' }); await loadData();
        }

        function renderDashboard() {
            document.getElementById('dash-count').innerText = students.length;
            let totalG = 0; let counts = { 4: 0, 3.5: 0, 3: 0, 2.5: 0, 2: 0, 1.5: 0, 1: 0, 0: 0 };
            students.forEach(s => {
                const sc = s.scores.find(x => x.subject_name === activeSubj.subject_name) || { collect_score: 0, midterm_score: 0, final_score: 0 };
                const t = sc.collect_score + sc.midterm_score + sc.final_score;
                let g = 0; if (t >= 80) g = 4; else if (t >= 75) g = 3.5; else if (t >= 70) g = 3; else if (t >= 65) g = 2.5; else if (t >= 60) g = 2; else if (t >= 55) g = 1.5; else if (t >= 50) g = 1;
                counts[g]++; totalG += g;
            });
            document.getElementById('dash-avg').innerText = students.length ? (totalG / students.length).toFixed(1) : "0.0";
            const date = document.getElementById('global-att-date').value;
            const pres = students.filter(s => s.attendance.some(a => a.check_date === date && a.status === 'P' && a.subject_name === activeSubj.subject_name)).length;
            document.getElementById('dash-att').innerText = students.length ? ((pres / students.length) * 100).toFixed(0) + "%" : "0%";
            if (window.myChart) window.myChart.destroy();
            window.myChart = new Chart(document.getElementById('gradeChart'), { type: 'bar', data: { labels: Object.keys(counts).reverse(), datasets: [{ label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', data: Object.values(counts).reverse(), backgroundColor: '#6366f1', borderRadius: 12 }] }, options: { responsive: true, maintainAspectRatio: false } });
        }

        function renderQRCards() {
            const con = document.getElementById('qr-cards-container'); con.innerHTML = "";
            students.forEach(s => {
                const card = document.createElement('div'); card.className = "bg-white p-8 rounded-[2rem] shadow-sm border border-slate-100 text-center qr-card-print space-y-4";
                card.innerHTML = `<p class="text-[10px] font-black text-indigo-500 uppercase">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${s.roll_number}</p><div id="qr-${s.id}" class="flex justify-center p-2"></div><p class="text-lg font-bold text-slate-800">${s.name}</p>`;
                con.appendChild(card); new QRCode(document.getElementById(`qr-${s.id}`), { text: s.std_id, width: 140, height: 140 });
            });
        }

        function renderClassSummary() {
            const con = document.getElementById('class-report-container');
            let html = `<div class="text-center mb-12"><h1 class="text-3xl font-black text-slate-900 mb-2">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1><p class="text-xl font-bold text-slate-500">‡∏ß‡∏¥‡∏ä‡∏≤: ${activeSubj.subject_name} | ‡∏ä‡∏±‡πâ‡∏ô: ${activeSubj.grade_level}</p></div><table class="w-full text-center border-collapse border-4 border-slate-900 text-lg font-bold"><thead><tr class="bg-slate-50"><th class="border-4 border-slate-900 p-4 w-16">‡∏ó‡∏µ‡πà</th><th class="border-4 border-slate-900 p-4 text-left">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th><th class="border-4 border-slate-900 p-4">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</th><th class="border-4 border-slate-900 p-4">‡πÄ‡∏Å‡∏£‡∏î</th><th class="border-4 border-slate-900 p-4">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô %</th></tr></thead><tbody>`;
            students.forEach(s => {
                const sc = s.scores.find(x => x.subject_name === activeSubj.subject_name) || { collect_score: 0, midterm_score: 0, final_score: 0 }; const t = sc.collect_score + sc.midterm_score + sc.final_score;
                let g = 0; if (t >= 80) g = 4; else if (t >= 75) g = 3.5; else if (t >= 70) g = 3; else if (t >= 65) g = 2.5; else if (t >= 60) g = 2; else if (t >= 55) g = 1.5; else if (t >= 50) g = 1;
                const atts = s.attendance.filter(a => a.subject_name === activeSubj.subject_name); const p = atts.filter(a => a.status === 'P').length, total = atts.length; const pct = total > 0 ? ((p / total) * 100).toFixed(0) : 0;
                html += `<tr><td class="border-4 border-slate-900 p-3 text-center">${s.roll_number}</td><td class="border-4 border-slate-900 p-3 text-left font-bold text-slate-800">${s.name}</td><td class="border-4 border-slate-900 p-3 font-black text-indigo-700 text-2xl text-center">${t}</td><td class="border-4 border-slate-900 p-3 text-3xl font-black text-center">${g}</td><td class="border-4 border-slate-900 p-3 font-black text-center">${pct}%</td></tr>`;
            });
            html += `</tbody></table><div class="mt-20 flex justify-between font-black italic"><span>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠......................................... (‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô)</span><span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date().toLocaleDateString('th-TH')}</span></div>`;
            con.innerHTML = html;
        }

        function stopScanner() { if (scanner && scanner.isScanning) scanner.stop(); }
        function openClassModal() { document.getElementById('classModal').classList.remove('hidden'); }
        function closeClassModal() { document.getElementById('classModal').classList.add('hidden'); }
        async function saveNewClass() {
            const l = document.getElementById('new-grade').value.trim(), c = document.getElementById('new-code').value.trim(), n = document.getElementById('new-name').value.trim();
            if (!l || !c || !n) return alert("‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
            const { error } = await _sb.from('classes').insert({ grade_level: l, subject_code: c, subject_name: n });
            if (error) alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + error.message); else location.reload();
        }
        function openBulk() { document.getElementById('bulkModal').classList.remove('hidden'); }
        function closeBulk() { document.getElementById('bulkModal').classList.add('hidden'); }
        function delStd(id) { if (confirm("‡∏•‡∏ö?")) _sb.from('students').delete().eq('id', id).then(() => loadData()); }
        window.onload = init;
    </script>
</body>

</html>
